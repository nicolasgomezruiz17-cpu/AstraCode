<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Assistant</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Marked.js para renderizar Markdown a HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- PDF.js para leer archivos PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Mermaid.js para diagramas -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        gemini: {
                            start: '#4E75F6',
                            end: '#E34F75'
                        }
                    }
                }
            }
        }
        // Configuración del worker de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Inicializar Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'default' });
    </script>

    <style>
        /* Estilos Markdown y Generales */
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #0c4a6e; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body strong { font-weight: 700; color: #334155; }
        .markdown-body code { background-color: rgba(0,0,0,0.05); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
        .markdown-body pre { background-color: #1e293b; color: #f8fafc; padding: 1em; border-radius: 8px; overflow-x: auto; margin-bottom: 1em; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        /* Gradiente Gemini */
        .bg-gradient-gemini { background: linear-gradient(135deg, #4E75F6 0%, #E34F75 100%); }
        .text-gradient-gemini { background: linear-gradient(135deg, #4E75F6 0%, #E34F75 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Estilos Chat */
        .chat-bubble { max-width: 85%; padding: 1rem; border-radius: 1rem; margin-bottom: 1rem; position: relative; animation: fadeIn 0.3s ease-out; }
        .chat-user { background-color: #eff6ff; color: #1e3a8a; margin-left: auto; border-bottom-right-radius: 0.2rem; }
        .chat-ai { background-color: #ffffff; border: 1px solid #e2e8f0; color: #334155; margin-right: auto; border-bottom-left-radius: 0.2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* Estilos Flashcards */
        .flashcard { perspective: 1000px; height: 200px; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .flashcard-front { background-color: #ffffff; border: 1px solid #e2e8f0; color: #1e293b; font-weight: bold; }
        .flashcard-back { background-color: #f0f9ff; border: 1px solid #bae6fd; color: #0c4a6e; transform: rotateY(180deg); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-graduation-cap text-brand-600 text-2xl mr-3"></i>
                    <span class="font-bold text-xl text-gray-900">StudyAI Assistant</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="toggleSettings()" class="text-gray-500 hover:text-brand-600 transition">
                        <i class="fa-solid fa-gear text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Modal de Configuración -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Configuración de APIs</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <p class="text-xs text-gray-500 mb-4 bg-yellow-50 p-2 rounded">
                <i class="fa-solid fa-lock mr-1"></i> Las claves se guardan solo en tu navegador.
            </p>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">OpenAI API Key</label>
                <input type="password" id="apiKeyInput" placeholder="sk-..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition">
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Google Gemini API Key <span class="text-xs text-blue-500 font-normal">(Recomendado para Chat)</span>
                </label>
                <input type="password" id="geminiKeyInput" placeholder="AIza..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none transition">
            </div>

            <button onclick="saveKeys()" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-2 px-4 rounded-lg transition shadow-md">
                Guardar Configuración
            </button>
        </div>
    </div>

    <!-- Contenido Principal -->
    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Panel Izquierdo: Entradas -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Tarjeta de Material -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-solid fa-folder-open mr-2 text-brand-500"></i> Tu Material
                </h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">¿Qué quieres aprender hoy?</label>
                    <textarea id="topicInput" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none resize-none" placeholder="Ej: Física Cuántica, Verbos en Inglés..."></textarea>
                </div>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase">O sube apuntes (PDF)</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <div class="mt-2">
                    <label class="flex justify-center w-full h-24 px-4 transition bg-white border-2 border-gray-300 border-dashed rounded-lg appearance-none cursor-pointer hover:border-brand-500 focus:outline-none" id="dropzone">
                        <span class="flex items-center space-x-2">
                            <i class="fa-solid fa-file-pdf text-red-400 text-xl"></i>
                            <span class="font-medium text-gray-600 text-sm" id="fileNameDisplay">Subir PDF</span>
                        </span>
                        <input type="file" name="file_upload" id="pdfInput" accept="application/pdf" class="hidden">
                    </label>
                    <p class="text-xs text-gray-500 mt-2 text-center" id="pdfStatus"></p>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Herramientas</h2>
                
                <div class="space-y-3">
                    <!-- Botón Chat Tutor (Destacado) -->
                    <button onclick="startTutorChat()" class="w-full flex items-center justify-between px-4 py-3 bg-brand-50 border border-brand-200 rounded-lg hover:bg-brand-100 hover:shadow-md transition group">
                        <div class="flex items-center">
                            <div class="bg-brand-500 text-white rounded-full p-2 mr-3 w-8 h-8 flex items-center justify-center">
                                <i class="fa-solid fa-comments"></i>
                            </div>
                            <div class="text-left">
                                <span class="font-bold text-brand-900 block">Profe Virtual</span>
                                <span class="text-xs text-brand-600">Chat interactivo y amable</span>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-brand-300 group-hover:text-brand-500"></i>
                    </button>

                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button onclick="generateSingle('plan')" class="px-3 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-sm font-medium text-gray-700">
                            <i class="fa-solid fa-calendar-check mr-1 text-green-500"></i> Plan
                        </button>
                        <button onclick="generateSingle('quiz')" class="px-3 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-sm font-medium text-gray-700">
                            <i class="fa-solid fa-pencil mr-1 text-orange-500"></i> Quiz
                        </button>
                    </div>

                    <!-- Gemini Tools -->
                    <div class="pt-4 border-t border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-2">Visual (Gemini)</p>
                        <button onclick="generateGeminiVisual('flashcards')" class="w-full flex items-center px-3 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-sm font-medium text-gray-700 mb-2">
                            <i class="fa-solid fa-clone mr-2 text-purple-500"></i> Flashcards
                        </button>
                        <button onclick="generateGeminiVisual('mindmap')" class="w-full flex items-center px-3 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-sm font-medium text-gray-700">
                            <i class="fa-solid fa-diagram-project mr-2 text-blue-500"></i> Mapa Mental
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Derecho: Resultados/Chat -->
        <div class="lg:col-span-8 flex flex-col h-[600px] lg:h-auto bg-white rounded-xl shadow-sm border border-gray-200 relative overflow-hidden">
            
            <!-- Header Resultados -->
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 flex-shrink-0">
                <h3 class="font-bold text-gray-700 flex items-center" id="panelTitle">
                    <i class="fa-solid fa-desktop mr-2 text-gray-400"></i> Área de Estudio
                </h3>
                <div class="flex space-x-2">
                    <button onclick="clearOutput()" class="text-xs text-gray-400 hover:text-red-500 transition" title="Limpiar">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Área de Contenido (Scrollable) -->
            <div id="outputArea" class="flex-grow p-6 overflow-y-auto bg-white scroll-smooth relative">
                <!-- Estado Inicial -->
                <div id="emptyState" class="flex flex-col items-center justify-center h-full text-gray-400">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fa-solid fa-robot text-4xl text-brand-300"></i>
                    </div>
                    <p class="text-lg font-medium text-gray-600">¡Hola! Soy tu asistente de estudio.</p>
                    <p class="text-sm mt-2 max-w-xs text-center">Sube un PDF o escribe un tema y elige una herramienta a la izquierda.</p>
                </div>
                <!-- Aquí se inyectarán los mensajes o contenido -->
            </div>

            <!-- Barra de Chat (Solo visible en modo chat) -->
            <div id="chatControls" class="hidden p-4 bg-gray-50 border-t border-gray-200 flex-shrink-0">
                <div class="flex space-x-2">
                    <input type="text" id="chatInput" class="flex-grow px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Escribe tu duda al profesor...">
                    <button onclick="sendUserMessage()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-3 rounded-lg font-bold transition shadow-sm">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Overlay de Carga -->
            <div id="loadingOverlay" class="absolute inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-20 hidden">
                <div class="loader mb-4"></div>
                <p class="text-gray-600 font-medium animate-pulse" id="loadingText">Pensando...</p>
            </div>
        </div>

    </main>

    <!-- JavaScript Lógica -->
    <script>
        // --- Variables Globales ---
        let extractedPdfText = "";
        let openAIKey = localStorage.getItem('openai_api_key') || "";
        let geminiKey = localStorage.getItem('gemini_api_key') || "";
        let chatHistory = []; // { role: 'user'|'model', text: '' }
        let isChatActive = false;

        // --- Inicialización ---
        window.addEventListener('DOMContentLoaded', () => {
            if (!openAIKey && !geminiKey) toggleSettings();
            else {
                if(openAIKey) document.getElementById('apiKeyInput').value = openAIKey;
                if(geminiKey) document.getElementById('geminiKeyInput').value = geminiKey;
            }
            
            // Enter para enviar mensaje
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendUserMessage();
            });
        });

        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('hidden');
        }

        function saveKeys() {
            const oKey = document.getElementById('apiKeyInput').value.trim();
            const gKey = document.getElementById('geminiKeyInput').value.trim();
            if (oKey) { openAIKey = oKey; localStorage.setItem('openai_api_key', oKey); }
            if (gKey) { geminiKey = gKey; localStorage.setItem('gemini_api_key', gKey); }
            toggleSettings();
            showNotification("Claves guardadas", "success");
        }

        // --- Gestión PDF ---
        document.getElementById('pdfInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.type !== 'application/pdf') return showNotification("Solo archivos PDF", "error");

            document.getElementById('fileNameDisplay').innerText = file.name.substring(0, 20) + "...";
            document.getElementById('pdfStatus').innerText = "Leyendo...";
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = "";
                const maxPages = Math.min(pdf.numPages, 15); 
                
                for (let i = 1; i <= maxPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + "\n";
                }
                extractedPdfText = fullText;
                document.getElementById('pdfStatus').innerText = "PDF Listo ✅";
                showNotification("PDF cargado con éxito", "success");
            } catch (error) {
                console.error(error);
                document.getElementById('pdfStatus').innerText = "Error";
            }
        });

        // --- Sistema de Chat Tutor ---
        async function startTutorChat() {
            const topic = document.getElementById('topicInput').value.trim();
            if (!topic && !extractedPdfText) return showNotification("Ingresa un tema o PDF primero", "error");

            isChatActive = true;
            chatHistory = []; // Reiniciar historial
            
            // Preparar UI
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('outputArea').innerHTML = ''; 
            document.getElementById('chatControls').classList.remove('hidden');
            document.getElementById('panelTitle').innerHTML = `<i class="fa-solid fa-comments mr-2 text-brand-500"></i> Profe Virtual`;

            // Prompt Inicial del Sistema (Invisible al usuario, se envía en la primera petición)
            const context = extractedPdfText ? `Basándote en este documento: ${extractedPdfText.substring(0, 15000)}...` : '';
            const systemPrompt = `
                Actúa como un profesor particular experto, empático y paciente. 
                Tu objetivo es que el estudiante aprenda y se sienta seguro.
                1. Usa un tono cálido y motivador (ej: '¡Buena pregunta!', 'Vamos a verlo paso a paso').
                2. Explica conceptos complejos con analogías sencillas.
                3. Al final de cada explicación, pregunta si se ha entendido (ej: '¿Te hace sentido esto?', '¿Quieres un ejemplo más?').
                4. Da consejos de estudio breves.
                5. Usa Markdown (negritas) para resaltar lo importante.
                
                Contexto inicial: El usuario quiere estudiar sobre: "${topic}". ${context}
                
                Saluda al estudiante por primera vez, dile qué van a aprender hoy basándote en el tema/PDF y hazle una pregunta inicial para medir su nivel o interés.
            `;

            // Añadir mensaje inicial de sistema al historial (interno)
            chatHistory.push({ role: 'system', text: systemPrompt });

            showLoading(true, "El profe está preparando la clase...");
            await callAI_Chat(); // Llamada inicial para que el bot salude
        }

        async function sendUserMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            // Mostrar mensaje usuario
            appendMessageToUI('user', text);
            chatHistory.push({ role: 'user', text: text });
            input.value = '';

            showLoading(true, "Escribiendo...");
            await callAI_Chat();
        }

        async function callAI_Chat() {
            try {
                let replyText = "";

                // Prioridad: Gemini (mejor contexto), luego OpenAI
                if (geminiKey) {
                    replyText = await fetchGeminiChat();
                } else if (openAIKey) {
                    replyText = await fetchOpenAIChat();
                } else {
                    throw new Error("No hay API Keys configuradas.");
                }

                chatHistory.push({ role: 'model', text: replyText });
                appendMessageToUI('ai', replyText);

            } catch (error) {
                appendMessageToUI('error', "Error: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        // --- Integración OpenAI (Chat) ---
        async function fetchOpenAIChat() {
            // Convertir historial 'model' -> 'assistant' para OpenAI
            const messages = chatHistory.map(m => ({
                role: m.role === 'model' ? 'assistant' : m.role,
                content: m.text
            }));

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openAIKey}` },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: messages
                })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.choices[0].message.content;
        }

        // --- Integración Gemini (Chat) ---
        async function fetchGeminiChat() {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`;
            
            // Construir prompt unificado para Gemini (ya que la API REST simple es stateless en este endpoint básico)
            // Una forma robusta es concatenar el historial en un string estructurado
            let fullPrompt = "";
            chatHistory.forEach(msg => {
                const roleLabel = msg.role === 'user' ? 'Student' : (msg.role === 'system' ? 'System Instruction' : 'Teacher');
                fullPrompt += `${roleLabel}: ${msg.text}\n\n`;
            });
            fullPrompt += "Teacher:";

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: fullPrompt }] }]
                })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        }

        // --- UI del Chat ---
        function appendMessageToUI(role, text) {
            const container = document.getElementById('outputArea');
            const div = document.createElement('div');
            div.className = `chat-bubble ${role === 'user' ? 'chat-user' : (role === 'error' ? 'bg-red-100 text-red-600' : 'chat-ai')}`;
            
            if (role === 'ai') {
                // Icono del profe
                const iconHtml = `<div class="flex items-center mb-2 text-brand-600 font-bold text-xs"><i class="fa-solid fa-graduation-cap mr-1"></i> Profe Virtual</div>`;
                div.innerHTML = iconHtml + marked.parse(text);
            } else if (role === 'user') {
                div.innerText = text;
            } else {
                div.innerText = text; // Error
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight; // Auto scroll
        }

        // --- Funciones de un solo uso (Plan, Quiz, etc) ---
        async function generateSingle(type) {
            // Reutilizamos la lógica del chat pero en modo "single shot" para mantener consistencia
            // Ocultamos controles de chat si estaban activos
            document.getElementById('chatControls').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('outputArea').innerHTML = '';
            document.getElementById('panelTitle').innerHTML = `<i class="fa-solid fa-bolt mr-2 text-yellow-500"></i> Resultado Rápido`;

            const topic = document.getElementById('topicInput').value;
            const context = extractedPdfText ? `Documento PDF: ${extractedPdfText.substring(0, 10000)}` : '';
            const prompt = `Contexto: ${topic} ${context}. \nTarea: Genera un ${type === 'plan' ? 'plan de estudio detallado con tabla' : 'quiz de 5 preguntas con respuestas al final'}. Usa Markdown.`;

            showLoading(true, "Generando...");
            try {
                let text = "";
                if (geminiKey) { // Preferir Gemini si está disponible
                     const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`;
                     const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                     const d = await res.json();
                     text = d.candidates[0].content.parts[0].text;
                } else if (openAIKey) {
                    const res = await fetch('https://api.openai.com/v1/chat/completions', { method: 'POST', headers: { 'Authorization': `Bearer ${openAIKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: 'gpt-4o-mini', messages: [{role: 'user', content: prompt}] }) });
                    const d = await res.json();
                    text = d.choices[0].message.content;
                } else {
                    throw new Error("Faltan API Keys");
                }
                document.getElementById('outputArea').innerHTML = `<div class="markdown-body p-4">${marked.parse(text)}</div>`;
            } catch (e) {
                document.getElementById('outputArea').innerHTML = `<div class="text-red-500">Error: ${e.message}</div>`;
            } finally {
                showLoading(false);
            }
        }

        async function generateGeminiVisual(type) {
            if (!geminiKey) return showNotification("Necesitas API Key de Gemini", "error");
            document.getElementById('chatControls').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('outputArea').innerHTML = '';
            
            const topic = document.getElementById('topicInput').value;
            const context = extractedPdfText ? extractedPdfText.substring(0, 15000) : topic;
            if (!context) return showNotification("Falta tema o PDF", "error");

            showLoading(true, "Gemini creando visuales... ✨");
            
            let prompt = "";
            if (type === 'flashcards') prompt = `Genera JSON puro: lista de 6 flashcards [{'term':'', 'definition':''}] sobre: ${context}`;
            if (type === 'mindmap') prompt = `Genera código Mermaid graph TD sobre: ${context}. Solo el código.`;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`;
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const d = await res.json();
                const text = d.candidates[0].content.parts[0].text;

                if (type === 'flashcards') {
                    const clean = text.replace(/```json|```/g, '').trim();
                    const cards = JSON.parse(clean);
                    let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">`;
                    cards.forEach(c => html += `<div class="flashcard group" onclick="this.classList.toggle('flipped')"><div class="flashcard-inner"><div class="flashcard-front bg-white border p-4 rounded shadow flex items-center justify-center font-bold">${c.term}</div><div class="flashcard-back bg-blue-50 border p-4 rounded shadow flex items-center justify-center text-sm">${c.definition}</div></div></div>`);
                    html += `</div>`;
                    document.getElementById('outputArea').innerHTML = html;
                } else {
                    const clean = text.replace(/```mermaid|```/g, '').trim();
                    document.getElementById('outputArea').innerHTML = `<div class="mermaid p-4 bg-gray-50 flex justify-center">${clean}</div>`;
                    mermaid.init();
                }
            } catch (e) {
                document.getElementById('outputArea').innerText = "Error: " + e.message;
            } finally {
                showLoading(false);
            }
        }

        // --- Utilidades ---
        function showLoading(show, msg) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
            if(msg) document.getElementById('loadingText').innerText = msg;
        }
        function clearOutput() {
            document.getElementById('outputArea').innerHTML = '';
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('chatControls').classList.add('hidden');
        }
        function showNotification(msg, type) {
            const div = document.createElement('div');
            div.className = `fixed bottom-4 right-4 px-6 py-3 rounded text-white z-50 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            div.innerText = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>
